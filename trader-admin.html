<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ASML Admin - P2P Mode</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* Keeping your existing styles... */
        body { font-family: sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; }
        .qr-section { text-align: center; background: #e8f4fd; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        #qrcode { display: inline-block; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border-bottom: 1px solid #ddd; padding: 12px; text-align: left; }
        .stat-box { display: flex; gap: 20px; margin-bottom: 20px; }
        .card { flex: 1; padding: 15px; background: #0061af; color: white; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ASML Trading Demo (Admin)</h1>

        <div class="qr-section">
            <h3>Invite Traders</h3>
            <p>Scan this QR code to join the game:</p>
            <div id="qrcode"></div>
            <p><small id="admin-id-display">Connecting to network...</small></p>
        </div>

        <div class="stat-box">
            <div class="card">Day: <span id="day-val">1</span></div>
            <div class="card">Price: €<span id="price-val">600</span></div>
            <div class="card">Connected: <span id="count-val">0</span></div>
        </div>

        <button onclick="advanceDay()" style="padding: 10px 20px; background: #4caf50; color: white; border: none; border-radius: 5px; cursor: pointer;">Next Day</button>

        <table>
            <thead>
                <tr>
                    <th>Trader</th>
                    <th>Shares</th>
                    <th>Cash</th>
                    <th>Portfolio</th>
                </tr>
            </thead>
            <tbody id="trader-list"></tbody>
        </table>
    </div>

    <script>
        let gameState = { day: 1, price: 600 };
        let traders = {};
        let peer = new Peer(); // Create a PeerJS object

        // 1. Initialize Admin Peer
        peer.on('open', (id) => {
            document.getElementById('admin-id-display').innerText = "Room ID: " + id;
            const userUrl = window.location.href.replace('admin.html', 'user.html') + "?room=" + id;

            // Generate QR Code
            new QRCode(document.getElementById("qrcode"), {
                text: userUrl,
                width: 128,
                height: 128
            });
        });

        // 2. Listen for User Connections
        peer.on('connection', (conn) => {
            conn.on('data', (data) => {
                // When a user sends their stats
                traders[data.id] = data;
                updateTable();

                // Sync the current price back to the user
                conn.send({ type: 'SYNC', day: gameState.day, price: gameState.price });
            });
        });

        function updateTable() {
            const tbody = document.getElementById('trader-list');
            tbody.innerHTML = '';
            const list = Object.values(traders);
            document.getElementById('count-val').innerText = list.length;

            list.forEach(t => {
                const total = t.cash + (t.shares * gameState.price);
                tbody.innerHTML += `<tr>
                    <td>${t.id}</td>
                    <td>${t.shares}</td>
                    <td>€${t.cash.toFixed(2)}</td>
                    <td><strong>€${total.toFixed(2)}</strong></td>
                </tr>`;
            });
        }

        function advanceDay() {
            gameState.day++;
            gameState.price += (Math.random() > 0.5 ? 100 : -100);
            document.getElementById('day-val').innerText = gameState.day;
            document.getElementById('price-val').innerText = gameState.price;

            // Broadcast new price to everyone (if you want to keep connections open)
            // For a simple demo, users usually send data to admin on every action.
            updateTable();
        }
    </script>
</body>
</html>
