<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ASML Admin - Day 5 Hard Stop</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --asml-blue: #0061af; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .market-status { padding: 10px; border-radius: 6px; font-weight: bold; margin-bottom: 20px; text-align: center; }
        .status-open { background: #e8f5e9; color: #2e7d32; }
        .status-closed { background: #ffebee; color: #c62828; }
        .stats { display: flex; gap: 20px; margin-bottom: 20px; }
        .stat-card { flex: 1; padding: 15px; background: var(--asml-blue); color: white; border-radius: 8px; text-align: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        .btn-advance { width: 100%; padding: 15px; background: #27ae60; color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; }
        .btn-advance:disabled { background: #bdc3c7; cursor: not-allowed; }
        #qrcode { margin-top: 15px; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <div id="market-banner" class="market-status status-open">MARKET OPEN</div>
        
        <div class="stats">
            <div class="stat-card">Day: <span id="day-val">1</span> / 5</div>
            <div class="stat-card">Price: €<span id="price-val">600</span></div>
            <div class="stat-card">Traders: <span id="count-val">0</span></div>
        </div>

        <button id="next-day-btn" class="btn-advance" onclick="advanceDay()">Advance to Next Day</button>

        <div id="qrcode"></div>

        <table>
            <thead>
                <tr>
                    <th>Trader</th>
                    <th>Shares</th>
                    <th>Cash</th>
                    <th>Total Value</th>
                </tr>
            </thead>
            <tbody id="trader-list"></tbody>
        </table>
    </div>

    <script>
        let gameState = { day: 1, price: 600, isClosed: false };
        let traders = {};
        let connections = [];
        const peer = new Peer();

        peer.on('open', (id) => {
            const userUrl = window.location.href.replace('admin.html', 'user.html') + "?room=" + id;
            new QRCode(document.getElementById("qrcode"), { text: userUrl, width: 128, height: 128 });
        });

        peer.on('connection', (conn) => {
            connections.push(conn);
            conn.on('data', (data) => {
                traders[data.id] = data;
                updateUI();
                conn.send({ type: 'SYNC', ...gameState });
            });
        });

        function advanceDay() {
            if (gameState.day >= 5) return;

            gameState.day++;
            gameState.price += (Math.random() > 0.5 ? 50 : -50);
            
            if (gameState.day === 5) {
                gameState.isClosed = true;
                document.getElementById('market-banner').innerText = "MARKET CLOSED - FINAL RESULTS";
                document.getElementById('market-banner').className = "market-status status-closed";
                document.getElementById('next-day-btn').disabled = true;
                document.getElementById('next-day-btn').innerText = "Demo Finished";
            }

            // Broadcast state to all users
            connections.forEach(c => c.send({ type: 'SYNC', ...gameState }));
            updateUI();
        }

        function updateUI() {
            document.getElementById('day-val').innerText = gameState.day;
            document.getElementById('price-val').innerText = gameState.price;
            const list = Object.values(traders).sort((a,b) => (b.cash + b.shares * gameState.price) - (a.cash + a.shares * gameState.price));
            document.getElementById('count-val').innerText = list.length;
            document.getElementById('trader-list').innerHTML = list.map(t => `
                <tr>
                    <td>${t.id}</td>
                    <td>${t.shares}</td>
                    <td>€${t.cash.toFixed(2)}</td>
                    <td><strong>€${(t.cash + t.shares * gameState.price).toFixed(2)}</strong></td>
                </tr>
            `).join('');
        }
    </script>
</body>
</html>
